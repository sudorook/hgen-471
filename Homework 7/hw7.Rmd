---
title: "Problem Set 7"
author: "Ansel George"
output: pdf_document
---

# Homework 7

## Problem 1
We are deriving a new test for pathway (SNP set) analysis. Suppose a pathway is
assigned $n$ SNPs, with p-values $p_1 , \hdots , p_n$. Our test is based on
one-sided $Z$-scores of these SNPs, $Z_1 , \hdots, Z_n$. The test statistic is
$Z = \sum_{i=1}^n Z_i$.

### (a)
Suppose the SNPs are all independent (not in LD), what is the null distribution
of $Z$?

### (b)
Now suppose the first two SNPs are in perfect LD, what is the null distribution
of $Z$?

### (c)
Suppose we have a pathway of $10$ SNPs, $p_1 = p 2 = 0.01$, $p_3 = p_4 = p_5 =
0.2$ and $p_6 = \hdots = p_10 = 0.75$. What is the p-value at the pathway
level in the two scenarios above? Under which scenario, the pathway is more
significant, and why?

### (d)
A related test is $T = \sum_i Z_i^2$. What is the null distribution of this
test? And compare the two methods, using $Z$ or $Z^2$ , which one do you
prefer, and why?


## Problem 2
In this problem, you will compare genetics of two traits using the polygenic
risk score approach we discussed in the class. You are given the genotype and
phenotype data of two traits. For simplicity, the data has only 4 SNPs, and
they are considered to be independent.

## (a)
Calculate the effect size of all SNPs in trait 1.

## (b)
Using the estimated effect sizes, compute polygenic risk score (PRS) of trait 1
in the samples of trait 2 (i.e. we predict the trait 1 phenotype in these
samples).

## (c)
Compute the correlation of the PRS with the phenotypes of trait 2.


## Problem 3
We will answer some conceptual questions about annotating functions of SNPs:

## (a)
Evolutionary constraint across species (e.g. PhastCons or GERP) is often used
to define functional sequences. For a researcher studying human cognitive
trait, what do you think is the limitation of using this annotation?

## (b)
Suppose we have a large number of whole-genome sequences of human, can you use
this dataset to improve annotation of functional non-coding sequences? You just
need to explain some general ideas.

## (c)
We have enhancer data (e.g. ATAC-seq) in a tissue related to disease of
interest. In addition, we have a list of transcription factors (TFs) likely
important in this tissue from prior studies and we know the motifs of all these
TFs. Can you propose a better annotation combining enhancer data with TF
information? (Hint: most variants, even within an enhancer, are likely not
functional.)

## (d)
Now suppose we also have experimental data that identified several thousand of
SNPs with likely regulatory effects (e.g. from large-scale reporter assay). Can
you use this dataset to provide an even better functional annotation? (Hint:
use Supervised Learning.)


# Lab 6

## Problem 1

*Why are each of the above four input files important for running an analysis
with Matrix eQTL? (Hint: What is the goal of Matrix eQTL? Are there categories
for the results?)*

`gencode.v12.annotation.gtf.gz` - gene annotation file

`geuvadis.annot.txt.gz` - SNP annotation information, provides information
regarding identity, etc of a SNP used for building regression models

`GD462.GeneQuantRPKM.50FN.samplename.resk10.txt.gz` - normalized gene
expression data, used to build a regression of genotype (SNP) into a linear
model for gene expression

`geuvadis.snps.txt.gz` - genotype data, used once the linear model is built to
predict gene expression


## Problem 2

*If we were looking at all gene-SNP pairs, this analysis would take about 10
hours to complete. Obviously, that is unfeasible for this lab and we had to
limit our scope. We could have either limited the number of genes or the number
of SNPs we examine for this lab exercise. Using your knowledge of R (and
abilities to search R documentation), describe how you can determine which it
was. Did we limit the number of genes or SNPs? (Hint: look at the sections
labeled '# snp' and '# gene expression' in the prepare_inputs_for_matrix-eqtl.r
file).*

Select the first 20 rows in the gene\_expression matrix.

```{r, eval=F}
gene_expression <- gene_expression[1:20, ]
```


## Problem 3

*Using the output files generated from the script above, how many genes are we
examining for our analysis? How many SNPs? What's our sample size?*

Number of genes: 20
```{bash, eval=F}
wc -l geuvadis_expression_data.txt
```

Number of samples: 373
```{bash, eval=F}
awk '{print NF}' geuvadis_expression_data.txt | sort -nu | tail -n 1
```

Number of SNPs: 3167497
```{bash, eval=F}
wc -l geuvadis_snp_location_data.txt
```


## Problem 4

*How many eQTLs were identified for the gene AFAP1L2? Provide the script you
used to determine this (consult previous lab commands for assistance with this,
if necessary).*

```{bash, eval=F}
grep -Rn AFAP1L2 | wc -l
```

Number of eQTLs: 3722


## Problem 5

*Provide the qqplot created from the script. Looking at our output files, how
many cis-eQTLs vs trans-eQTLs did we find in our analysis (combined across all
genes)? Is this what we might naively expect? What could result in such a high
number of QTLs? Hints: 1) Only basic QC has been applied to SNPs used in the
analysis (see Plink lab section 1.5.1 for more) & 2) Open up the output files
and compare the statstics for groups of QTLs.*

![qqplot](results/eqtls/gevadis_eQTL_QQ-plot.png)

Number cis-eQTLs: 1

Number trans-eQTL: 10591

Many of the trans-eQTLs have identical summary statistics, suggesting that many
of them are in linkage disequilibrium with one other. SNPs within a linkage
block with have the same summary statistics to with respect to an SNP outside
the block.


## Problem 6

*Examining the prepare_inputs_for_predixcan.r script and seeing its resulting
files, what do you think the section "# prepare genotype files (split 1 to 22)"
is doing? Why might it be important (or at least efficient) to do this?*

The genotypes are being split among the 22 chromosomes.


## Problem 7

*Examining the run_predixcan bash script, we can see that it calls for the
chromosome and sample files that we created in section 2.1. However, it also
calls for another file in the /datasets directory called
"gtex_v7_Cells_EBV-transformed_lymphocytes_imputed_europeans_tw_0.5_signif.db".
Given your knowledge of what the other input files are and of the PrediXcan
method in general, what do you think this new file is and why is it important?*


## Problem 8

*Similar to our exercise with Matrix eQTL, we are not creating correlations for
all genes in the genome due to time and storage space concerns. What line in
the **run_correlation.R** script limits the number of genes we're doing
correlations on? How many genes are we observing correlations for in this lab?*


```{r,eval=F}
filter (V3=='gene') %>% filter(V1 != 'chrX' & V1 != 'chrY' & V1 != 'chrM') %>%
```

Filter the data so that only genes that are not in the X, Y, or mitochondrial
chromosomes are considered. Then,

```{r,eval=F}
genes <- unique(joined$gene_symbol)[1:18]
```

Consider only the first 18 genes.


## Problem 9

*What gene demonstrates the greatest amount of correlation between observed and
predicted gene expression in our sample? Provide the correlation plot for it.*


